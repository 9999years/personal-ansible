---
- name: Check for Rust
  register: rust_check
  stat:
      path: '{{ ansible_user_dir }}/.cargo/bin/rustup'
  changed_when: not (rust_check.stat.exists and rust_check.stat.executable)

- name: Install Rust
  when: rust_check is changed
  block:
      - name: Create temporary file
        # Create a directory because if `rustup-init` isn't named `rustup-init`
        # it doesn't know what to do.
        tempfile:
            state: directory
        register: rustup_tmp

      - name: Download rustup-init
        get_url:
            url: '{{ rustup_url }}'
            dest: '{{ rustup_tmp.path }}/rustup-init'
            force: true
            mode: 0755

      - name: Execute rustup-init
        command: >-
            {{ rustup_tmp.path }}/rustup-init
            --no-modify-path
            -y

- name: Upgrade Rust
  when: rust_check is not changed
  command: '{{ cargo_bin_dir }}/rustup update'

- name: Ensure Rust components are up-to-date
  loop:
    - cargo
    - clippy
    - docs
    - rust-src
  command: '{{ cargo_bin_dir }}/rustup component add {{ item }}'

- name: Install rust-analyzer
  import_tasks: rust-analyzer.yml
